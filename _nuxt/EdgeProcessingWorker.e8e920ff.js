import{n as Ot}from"./deduplicate.98a605b2.js";import{y as St,u as Et,i as yt,c as vt,l as Tt,p as bt,o as Dt,m as Pt,T as Lt,h as Vt,a as _t,b as Mt,d as Ft,A as Rt,O as Ut,x as xt,g as Bt,w as Ct,E as Ht,L as Wt,B as zt,F as Gt,I as jt,U as kt,j as qt,V as Kt,M as Xt,S as Jt,k as Yt,q as Qt,v as Zt,z as te,C as ee,D as ne,G as re,H as oe}from"./BufferView.1315c973.js";import{br as se,bs as pt,bt as E,bu as nt,bv as ie,bw as ae,bx as ce,by as H,bz as rt,bA as z,bB as fe,bC as ue,bD as dt,bE as ot,bF as le}from"./entry.a426b012.js";import{C as D}from"./enums.ad15c731.js";import{t as ge}from"./VertexElementDescriptor.b51b5c8c.js";import{T as X}from"./InterleavedLayout.e77ae48f.js";import{O as d}from"./VertexAttribute.90c6b2b6.js";import"./vec2.70118006.js";import"./types.373a6e47.js";var pe=Object.defineProperty,de=Object.defineProperties,me=Object.getOwnPropertyDescriptors,st=Object.getOwnPropertySymbols,he=Object.prototype.hasOwnProperty,Ne=Object.prototype.propertyIsEnumerable,it=(t,e,n)=>e in t?pe(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,$e=(t,e)=>{for(var n in e||(e={}))he.call(e,n)&&it(t,n,e[n]);if(st)for(var n of st(e))Ne.call(e,n)&&it(t,n,e[n]);return t},we=(t,e)=>de(t,me(e));function at(t,e,n){const s=e/3,o=new Uint32Array(n+1),a=new Uint32Array(n+1),p=(r,i)=>{r<i?o[r+1]++:a[i+1]++};for(let r=0;r<s;r++){const i=t[3*r],l=t[3*r+1],g=t[3*r+2];p(i,l),p(l,g),p(g,i)}let c=0,m=0;for(let r=0;r<n;r++){const i=o[r+1],l=a[r+1];o[r+1]=c,a[r+1]=m,c+=i,m+=l}const f=new Uint32Array(6*s),u=o[n],N=(r,i,l)=>{if(r<i){const g=o[r+1]++;f[2*g]=i,f[2*g+1]=l}else{const g=a[i+1]++;f[2*u+2*g]=r,f[2*u+2*g+1]=l}};for(let r=0;r<s;r++){const i=t[3*r],l=t[3*r+1],g=t[3*r+2];N(i,l,r),N(l,g,r),N(g,i,r)}const $=(r,i)=>{const l=2*r,g=i-r;for(let I=1;I<g;I++){const S=f[l+2*I],T=f[l+2*I+1];let A=I-1;for(;A>=0&&f[l+2*A]>S;A--)f[l+2*A+2]=f[l+2*A],f[l+2*A+3]=f[l+2*A+1];f[l+2*A+2]=S,f[l+2*A+3]=T}};for(let r=0;r<n;r++)$(o[r],o[r+1]),$(u+a[r],u+a[r+1]);const h=new Int32Array(3*s),y=(r,i)=>r===t[3*i]?0:r===t[3*i+1]?1:r===t[3*i+2]?2:-1,w=(r,i)=>{const l=y(r,i);h[3*i+l]=-1},v=(r,i,l,g)=>{const I=y(r,i);h[3*i+I]=g;const S=y(l,g);h[3*g+S]=i};for(let r=0;r<n;r++){let i=o[r];const l=o[r+1];let g=a[r];const I=a[r+1];for(;i<l&&g<I;){const S=f[2*i],T=f[2*u+2*g];S===T?(v(r,f[2*i+1],T,f[2*u+2*g+1]),i++,g++):S<T?(w(r,f[2*i+1]),i++):(w(T,f[2*u+2*g+1]),g++)}for(;i<l;)w(r,f[2*i+1]),i++;for(;g<I;)w(f[2*u+2*g],f[2*u+2*g+1]),g++}return h}function ct(t,e){return e.push(t.buffer),{buffer:t.buffer,layout:Ie(t.layout)}}function Ie(t){const e=new Array;return t.fields.forEach((n,s)=>{const o=we($e({},n),{constructor:mt(n.constructor)});e.push([s,o])}),{stride:t.stride,fields:e,fieldNames:t.fieldNames}}const Ae=[St,Et,yt,vt,Tt,bt,Dt,Pt,Lt,Vt,_t,Mt,Ft,Rt,Ut,xt,Bt,Ct,Ht,Wt,zt,Gt,jt,kt,qt,Kt,Xt,Jt,Yt,Qt,Zt,te,ee,ne,re,oe];function mt(t){return`${t.ElementType}_${t.ElementCount}`}const Oe=new Map;Ae.forEach(t=>Oe.set(mt(t),t));function J(t,e=0){const n=t.stride;return t.fieldNames.filter(s=>{const o=t.fields.get(s).optional;return!(o&&o.glPadding)}).map(s=>{const o=t.fields.get(s),a=o.constructor.ElementCount,p=Se(o.constructor.ElementType),c=o.offset,m=!(!o.optional||!o.optional.glNormalized);return new ge(s,a,p,c,n,m,e)})}function Se(t){const e=Ee[t];if(e)return e;throw new Error("BufferType not supported in WebGL")}const Ee={u8:D.UNSIGNED_BYTE,u16:D.UNSIGNED_SHORT,u32:D.UNSIGNED_INT,i8:D.BYTE,i16:D.SHORT,i32:D.INT,f32:D.FLOAT},ht=X().vec3f(d.POSITION).u16(d.COMPONENTINDEX).u16(d.U16PADDING),ye=X().vec2u8(d.SIDENESS);J(ye);const Nt=X().vec3f(d.POSITION0).vec3f(d.POSITION1).u16(d.COMPONENTINDEX).u8(d.VARIANTOFFSET,{glNormalized:!0}).u8(d.VARIANTSTROKE).u8(d.VARIANTEXTENSION,{glNormalized:!0}).u8(d.U8PADDING,{glPadding:!0}).u16(d.U16PADDING,{glPadding:!0}),G=Nt.clone().vec3f(d.NORMAL),j=Nt.clone().vec3f(d.NORMALA).vec3f(d.NORMALB);d.POSITION0,d.POSITION1,d.COMPONENTINDEX,d.VARIANTOFFSET,d.VARIANTSTROKE,d.VARIANTEXTENSION,d.NORMAL,d.NORMALA,d.NORMALB,d.SIDENESS;class $t{updateSettings(e){this.settings=e,this.edgeHashFunction=e.reducedPrecision?Te:ve}write(e,n,s){const o=this.edgeHashFunction(s);x.seed=o;const a=x.getIntRange(0,255),p=x.getIntRange(0,this.settings.variants-1),c=.7,m=x.getFloat(),f=255*(.5*be(-(1-Math.min(m/c,1))+Math.max(0,m-c)/(1-c),1.2)+.5);e.position0.setVec(n,s.position0),e.position1.setVec(n,s.position1),e.componentIndex.set(n,s.componentIndex),e.variantOffset.set(n,a),e.variantStroke.set(n,p),e.variantExtension.set(n,f)}trim(e,n){return e.slice(0,n)}}const Y=new Float32Array(6),B=new Uint32Array(Y.buffer),b=new Uint32Array(1);function ve(t){const e=Y;e[0]=t.position0[0],e[1]=t.position0[1],e[2]=t.position0[2],e[3]=t.position1[0],e[4]=t.position1[1],e[5]=t.position1[2],b[0]=5381;for(let n=0;n<B.length;n++)b[0]=31*b[0]+B[n];return b[0]}function Te(t){const e=Y;e[0]=_(t.position0[0]),e[1]=_(t.position0[1]),e[2]=_(t.position0[2]),e[3]=_(t.position1[0]),e[4]=_(t.position1[1]),e[5]=_(t.position1[2]),b[0]=5381;for(let n=0;n<B.length;n++)b[0]=31*b[0]+B[n];return b[0]}const ft=1e4;function _(t){return Math.round(t*ft)/ft}function be(t,e){const n=t<0?-1:1;return Math.abs(t)**e*n}class k{constructor(){this.commonWriter=new $t}updateSettings(e){this.commonWriter.updateSettings(e)}allocate(e){return G.createBuffer(e)}write(e,n,s){this.commonWriter.write(e,n,s),se(U,s.faceNormal0,s.faceNormal1),pt(U,U),e.normal.setVec(n,U)}trim(e,n){return this.commonWriter.trim(e,n)}}k.Layout=G,k.glLayout=J(G,1);class q{constructor(){this.commonWriter=new $t}updateSettings(e){this.commonWriter.updateSettings(e)}allocate(e){return j.createBuffer(e)}write(e,n,s){this.commonWriter.write(e,n,s),e.normalA.setVec(n,s.faceNormal0),e.normalB.setVec(n,s.faceNormal1)}trim(e,n){return this.commonWriter.trim(e,n)}}q.Layout=j,q.glLayout=J(j,1);const U=E(),x=new le,P=-1;var ut;function De(t,e,n,s=Fe){const o=t.vertices.position,a=t.vertices.componentIndex,p=nt(s.anglePlanar),c=nt(s.angleSignificantEdge),m=Math.cos(c),f=Math.cos(p),u=K.edge,N=u.position0,$=u.position1,h=u.faceNormal0,y=u.faceNormal1,w=Me(t),v=_e(t),r=v.length/4,i=e.allocate(r);let l=0;const g=r,I=n.allocate(g);let S=0,T=0,A=0;const Q=ie(0,r),F=new Float32Array(r);ae(F,(L,O,M)=>{o.getVec(v[4*O+0],N),o.getVec(v[4*O+1],$),M[O]=ce(N,$)}),Q.sort((L,O)=>F[O]-F[L]);const Z=new Array,tt=new Array;for(let L=0;L<r;L++){const O=Q[L],M=F[O],C=v[4*O+0],At=v[4*O+1],V=v[4*O+2],R=v[4*O+3],et=R===P;if(o.getVec(C,N),o.getVec(At,$),et)H(h,w[3*V+0],w[3*V+1],w[3*V+2]),rt(y,h),u.componentIndex=a.get(C),u.cosAngle=z(h,y);else{if(H(h,w[3*V+0],w[3*V+1],w[3*V+2]),H(y,w[3*R+0],w[3*R+1],w[3*R+2]),u.componentIndex=a.get(C),u.cosAngle=z(h,y),Le(u,f))continue;u.cosAngle<-.9999&&rt(y,h)}T+=M,A++,et||Pe(u,m)?(e.write(i,l++,u),Z.push(M)):Ve(u,p)&&(n.write(I,S++,u),tt.push(M))}const wt=new Float32Array(Z.reverse()),It=new Float32Array(tt.reverse());return{regular:{instancesData:e.trim(i,l),lodInfo:{lengths:wt}},silhouette:{instancesData:n.trim(I,S),lodInfo:{lengths:It}},averageEdgeLength:T/A}}function Pe(t,e){return t.cosAngle<e}function Le(t,e){return t.cosAngle>e}function Ve(t,e){const n=fe(t.cosAngle),s=K.fwd,o=K.ortho;return ue(s,t.position1,t.position0),n*(z(dt(o,t.faceNormal0,t.faceNormal1),s)>0?-1:1)>e}function _e(t){const e=t.faces.length/3,n=t.faces,s=t.neighbors;let o=0;for(let c=0;c<e;c++){const m=s[3*c+0],f=s[3*c+1],u=s[3*c+2],N=n[3*c+0],$=n[3*c+1],h=n[3*c+2];o+=m===P||N<$?1:0,o+=f===P||$<h?1:0,o+=u===P||h<N?1:0}const a=new Int32Array(4*o);let p=0;for(let c=0;c<e;c++){const m=s[3*c+0],f=s[3*c+1],u=s[3*c+2],N=n[3*c+0],$=n[3*c+1],h=n[3*c+2];(m===P||N<$)&&(a[p++]=N,a[p++]=$,a[p++]=c,a[p++]=m),(f===P||$<h)&&(a[p++]=$,a[p++]=h,a[p++]=c,a[p++]=f),(u===P||h<N)&&(a[p++]=h,a[p++]=N,a[p++]=c,a[p++]=u)}return a}function Me(t){const e=t.faces.length/3,n=t.vertices.position,s=t.faces,o=W.v0,a=W.v1,p=W.v2,c=new Float32Array(3*e);for(let m=0;m<e;m++){const f=s[3*m+0],u=s[3*m+1],N=s[3*m+2];n.getVec(f,o),n.getVec(u,a),n.getVec(N,p),ot(a,a,o),ot(p,p,o),dt(o,a,p),pt(o,o),c[3*m+0]=o[0],c[3*m+1]=o[1],c[3*m+2]=o[2]}return c}(function(t){t[t.SOLID=0]="SOLID",t[t.SKETCH=1]="SKETCH"})(ut||(ut={}));const K={edge:{position0:E(),position1:E(),faceNormal0:E(),faceNormal1:E(),componentIndex:0,cosAngle:0},ortho:E(),fwd:E()},W={v0:E(),v1:E(),v2:E()},Fe={anglePlanar:4,angleSignificantEdge:35};async function Xe(t){const e=Ue(t),n=Re(e),s=[e.data.buffer];return{result:xe(n,s),transferList:s}}function Re(t){const e=Be(t.data,t.skipDeduplicate,t.indices,t.indicesLength);return lt.updateSettings(t.writerSettings),gt.updateSettings(t.writerSettings),De(e,lt,gt)}function Ue(t){return{data:ht.createView(t.dataBuffer),indices:t.indicesType==="Uint32Array"?new Uint32Array(t.indicesBuffer):t.indicesType==="Uint16Array"?new Uint16Array(t.indicesBuffer):void 0,indicesLength:t.indicesLength,writerSettings:t.writerSettings,skipDeduplicate:t.skipDeduplicate}}function xe(t,e){return e.push(t.regular.lodInfo.lengths.buffer),e.push(t.silhouette.lodInfo.lengths.buffer),{regular:{instancesData:ct(t.regular.instancesData,e),lodInfo:{lengths:t.regular.lodInfo.lengths.buffer}},silhouette:{instancesData:ct(t.silhouette.instancesData,e),lodInfo:{lengths:t.silhouette.lodInfo.lengths.buffer}},averageEdgeLength:t.averageEdgeLength}}function Be(t,e,n,s){if(e)return{faces:n,facesLength:s,neighbors:at(n,s,t.count),vertices:t};const o=Ot(t.buffer,t.stride/4,{originalIndices:n,originalIndicesLength:s}),a=at(o.indices,s,o.uniqueCount);return{faces:o.indices,facesLength:o.indices.length,neighbors:a,vertices:ht.createView(o.buffer)}}const lt=new k,gt=new q;export{Re as work,Xe as wrappedWork};
