import{a4 as q,r as U,cp as J,g as k,cq as G,t as W,o as p,h as K}from"./entry.d0d45c75.js";import{w as Q}from"./quat.98ba9431.js";import{t as ee,n as E}from"./vec3f32.a99d9267.js";import{F as te}from"./projection.9afbc7bb.js";import{a as re,b as ne,d as oe}from"./PointCloudUniqueValueRenderer.1ff5072a.js";import{O}from"./VertexAttribute.90c6b2b6.js";var ie=Object.defineProperty,ae=Object.defineProperties,se=Object.getOwnPropertyDescriptors,V=Object.getOwnPropertySymbols,ue=Object.prototype.hasOwnProperty,ce=Object.prototype.propertyIsEnumerable,Y=(t,e,n)=>e in t?ie(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,P=(t,e)=>{for(var n in e||(e={}))ue.call(e,n)&&Y(t,n,e[n]);if(V)for(var n of V(e))ce.call(e,n)&&Y(t,n,e[n]);return t},S=(t,e)=>ae(t,se(e));function le(){const t=new Float32Array(4);return t[3]=1,t}const y=!0,C={identifierOffset:0,identifierLength:10,versionOffset:10,checksumOffset:12,byteCount:16};function _(t,e,n){return{identifier:String.fromCharCode.apply(null,new Uint8Array(t,n+C.identifierOffset,C.identifierLength)),version:e.getUint16(n+C.versionOffset,y),checksum:e.getUint32(n+C.checksumOffset,y)}}const h={sizeLo:0,sizeHi:4,minX:8,minY:16,minZ:24,maxX:32,maxY:40,maxZ:48,errorX:56,errorY:64,errorZ:72,count:80,reserved:84,byteCount:88};function fe(t,e){return{sizeLo:t.getUint32(e+h.sizeLo,y),sizeHi:t.getUint32(e+h.sizeHi,y),minX:t.getFloat64(e+h.minX,y),minY:t.getFloat64(e+h.minY,y),minZ:t.getFloat64(e+h.minZ,y),maxX:t.getFloat64(e+h.maxX,y),maxY:t.getFloat64(e+h.maxY,y),maxZ:t.getFloat64(e+h.maxZ,y),errorX:t.getFloat64(e+h.errorX,y),errorY:t.getFloat64(e+h.errorY,y),errorZ:t.getFloat64(e+h.errorZ,y),count:t.getUint32(e+h.count,y),reserved:t.getUint32(e+h.reserved,y)}}function de(t){const e=new DataView(t,0);let n=0;const{identifier:i,version:s}=_(t,e,n);if(n+=C.byteCount,i!=="LEPCC     ")throw new p("lepcc-decode-error","Bad identifier");if(s>1)throw new p("lepcc-decode-error","Unknown version");const r=fe(e,n);if(n+=h.byteCount,r.sizeHi*2**32+r.sizeLo!==t.byteLength)throw new p("lepcc-decode-error","Bad size");const a=new Float64Array(3*r.count),c=[],o=[],l=[],u=[];if(n=M(t,n,c),n=M(t,n,o),n=M(t,n,l),n=M(t,n,u),n!==t.byteLength)throw new p("lepcc-decode-error","Bad length");let f=0,d=0;for(let b=0;b<c.length;b++){d+=c[b];let g=0;for(let w=0;w<o[b];w++){g+=l[f];const I=u[f];a[3*f]=Math.min(r.maxX,r.minX+2*r.errorX*g),a[3*f+1]=Math.min(r.maxY,r.minY+2*r.errorY*d),a[3*f+2]=Math.min(r.maxZ,r.minZ+2*r.errorZ*I),f++}}return{errorX:r.errorX,errorY:r.errorY,errorZ:r.errorZ,result:a}}function M(t,e,n){const i=[];e=L(t,e,i);const s=[];for(let r=0;r<i.length;r++){s.length=0,e=L(t,e,s);for(let a=0;a<s.length;a++)n.push(s[a]+i[r])}return e}function L(t,e,n){const i=new DataView(t,e),s=i.getUint8(0),r=31&s,a=!!(32&s),c=(192&s)>>6;let o=0;if(c===0)o=i.getUint32(1,y),e+=5;else if(c===1)o=i.getUint16(1,y),e+=3;else{if(c!==2)throw new p("lepcc-decode-error","Bad count type");o=i.getUint8(1),e+=2}if(a)throw new p("lepcc-decode-error","LUT not implemented");const l=Math.ceil(o*r/8),u=new Uint8Array(t,e,l);let f=0,d=0,b=0;const g=-1>>>32-r;for(let w=0;w<o;w++){for(;d<r;)f|=u[b]<<d,d+=8,b+=1;n[w]=f&g,f>>>=r,d-=r,d+r>32&&(f|=u[b-1]>>8-d)}return e+b}const m={sizeLo:0,sizeHi:4,count:8,colorMapCount:12,lookupMethod:14,compressionMethod:15,byteCount:16};function be(t,e){return{sizeLo:t.getUint32(e+m.sizeLo,y),sizeHi:t.getUint32(e+m.sizeHi,y),count:t.getUint32(e+m.count,y),colorMapCount:t.getUint16(e+m.colorMapCount,y),lookupMethod:t.getUint8(e+m.lookupMethod),compressionMethod:t.getUint8(e+m.compressionMethod)}}function pe(t){const e=new DataView(t,0);let n=0;const{identifier:i,version:s}=_(t,e,n);if(n+=C.byteCount,i!=="ClusterRGB")throw new p("lepcc-decode-error","Bad identifier");if(s>1)throw new p("lepcc-decode-error","Unknown version");const r=be(e,n);if(n+=m.byteCount,r.sizeHi*2**32+r.sizeLo!==t.byteLength)throw new p("lepcc-decode-error","Bad size");if((r.lookupMethod===2||r.lookupMethod===1)&&r.compressionMethod===0){if(3*r.colorMapCount+r.count+n!==t.byteLength||r.colorMapCount>256)throw new p("lepcc-decode-error","Bad count");const a=new Uint8Array(t,n,3*r.colorMapCount),c=new Uint8Array(t,n+3*r.colorMapCount,r.count),o=new Uint8Array(3*r.count);for(let l=0;l<r.count;l++){const u=c[l];o[3*l]=a[3*u],o[3*l+1]=a[3*u+1],o[3*l+2]=a[3*u+2]}return o}if(r.lookupMethod===0&&r.compressionMethod===0){if(3*r.count+n!==t.byteLength||r.colorMapCount!==0)throw new p("lepcc-decode-error","Bad count");return new Uint8Array(t,n).slice()}if(r.lookupMethod<=2&&r.compressionMethod===1){if(n+3!==t.byteLength||r.colorMapCount!==1)throw new p("lepcc-decode-error","Bad count");const a=e.getUint8(n),c=e.getUint8(n+1),o=e.getUint8(n+2),l=new Uint8Array(3*r.count);for(let u=0;u<r.count;u++)l[3*u]=a,l[3*u+1]=c,l[3*u+2]=o;return l}throw new p("lepcc-decode-error","Bad method "+r.lookupMethod+","+r.compressionMethod)}const v={sizeLo:0,sizeHi:4,count:8,scaleFactor:12,bitsPerPoint:14,reserved:15,byteCount:16};function ye(t,e){return{sizeLo:t.getUint32(e+v.sizeLo,y),sizeHi:t.getUint32(e+v.sizeHi,y),count:t.getUint32(e+v.count,y),scaleFactor:t.getUint16(e+v.scaleFactor,y),bitsPerPoint:t.getUint8(e+v.bitsPerPoint),reserved:t.getUint8(e+v.reserved)}}function ge(t){const e=new DataView(t,0);let n=0;const{identifier:i,version:s}=_(t,e,n);if(n+=C.byteCount,i!=="Intensity ")throw new p("lepcc-decode-error","Bad identifier");if(s>1)throw new p("lepcc-decode-error","Unknown version");const r=ye(e,n);if(n+=v.byteCount,r.sizeHi*2**32+r.sizeLo!==t.byteLength)throw new p("lepcc-decode-error","Bad size");const a=new Uint16Array(r.count);if(r.bitsPerPoint===8){if(r.count+n!==t.byteLength)throw new p("lepcc-decode-error","Bad size");const c=new Uint8Array(t,n,r.count);for(let o=0;o<r.count;o++)a[o]=c[o]*r.scaleFactor}else if(r.bitsPerPoint===16){if(2*r.count+n!==t.byteLength)throw new p("lepcc-decode-error","Bad size");const c=new Uint16Array(t,n,r.count);for(let o=0;o<r.count;o++)a[o]=c[o]*r.scaleFactor}else{const c=[];if(L(t,n,c)!==t.byteLength)throw new p("lepcc-decode-error","Bad size");for(let o=0;o<r.count;o++)a[o]=c[o]*r.scaleFactor}return a}const x=q.getLogger("esri.views.3d.layers.i3s.I3SBinaryReader");function he(t,e,n){let i="",s=0;for(;s<n;){const r=t[e+s];if(r<128)i+=String.fromCharCode(r),s++;else if(r>=192&&r<224){if(s+1>=n)throw new p("utf8-decode-error","UTF-8 Decode failed. Two byte character was truncated.");const a=(31&r)<<6|63&t[e+s+1];i+=String.fromCharCode(a),s+=2}else if(r>=224&&r<240){if(s+2>=n)throw new p("utf8-decode-error","UTF-8 Decode failed. Multi byte character was truncated.");const a=(15&r)<<12|(63&t[e+s+1])<<6|63&t[e+s+2];i+=String.fromCharCode(a),s+=3}else{if(!(r>=240&&r<248))throw new p("utf8-decode-error","UTF-8 Decode failed. Invalid multi byte sequence.");{if(s+3>=n)throw new p("utf8-decode-error","UTF-8 Decode failed. Multi byte character was truncated.");const a=(7&r)<<18|(63&t[e+s+1])<<12|(63&t[e+s+2])<<6|63&t[e+s+3];if(a>=65536){const c=55296+(a-65536>>10),o=56320+(1023&a);i+=String.fromCharCode(c,o)}else i+=String.fromCharCode(a);s+=4}}}return i}function N(t,e){const n={byteOffset:0,byteCount:0,fields:Object.create(null)};let i=0;for(let s=0;s<e.length;s++){const r=e[s],a=r.valueType||r.type,c=Oe[a];n.fields[r.property]=c(t,i),i+=$[a].BYTES_PER_ELEMENT}return n.byteCount=i,n}function we(t,e,n){const i=[];let s,r,a=0;for(r=0;r<t;r+=1){if(s=e[r],s>0){if(i.push(he(n,a,s-1)),n[a+s-1]!==0)throw new p("string-array-error","Invalid string array: missing null termination.")}else i.push(null);a+=s}return i}function T(t,e){return new $[e.valueType](t,e.byteOffset,e.count*e.valuesPerElement)}function me(t,e){return new Uint8Array(t,e.byteOffset,e.byteCount)}function ve(t,e,n){const i=e.header!=null?N(t,e.header):{byteOffset:0,byteCount:0,fields:{count:n}},s={header:i,byteOffset:i.byteCount,byteCount:0,entries:Object.create(null)};let r=i.byteCount;for(let a=0;a<e.ordering.length;a++){const c=e.ordering[a],o=K(e[c]);if(o.count=i.fields.count,o.valueType==="String"){if(o.byteOffset=r,o.byteCount=i.fields[c+"ByteCount"],o.encoding!=="UTF-8")throw new p("unsupported-encoding","Unsupported String encoding.",{encoding:o.encoding})}else{if(!H(o.valueType))throw new p("unsupported-value-type","Unsupported binary valueType",{valueType:o.valueType});{const l=z(o.valueType);r+=r%l!=0?l-r%l:0,o.byteOffset=r,o.byteCount=l*o.valuesPerElement*o.count}}r+=o.byteCount,s.entries[c]=o}return s.byteCount=r-s.byteOffset,s}function j(t,e,n){if(e!==t&&x.error(`Invalid ${n} buffer size
 expected: ${t}, actual: ${e})`),e<t)throw new p("buffer-too-small","Binary buffer is too small",{expectedSize:t,actualSize:e})}function Ce(t,e){const n=N(t,e&&e.header);let i=n.byteCount;const s={isDraco:!1,header:n,byteOffset:n.byteCount,byteCount:0,vertexAttributes:{}},r=n.fields,a=r.vertexCount!=null?r.vertexCount:r.count;for(const l of e.ordering){if(!e.vertexAttributes[l])continue;const u=S(P({},e.vertexAttributes[l]),{byteOffset:i,count:a}),f=R[l]?R[l]:"_"+l;s.vertexAttributes[f]=u,i+=z(u.valueType)*u.valuesPerElement*a}const c=r.faceCount;if(e.faces&&c){s.faces={};for(const l of e.ordering){if(!e.faces[l])continue;const u=S(P({},e.faces[l]),{byteOffset:i,count:c});s.faces[l]=u,i+=z(u.valueType)*u.valuesPerElement*c}}const o=r.featureCount;if(e.featureAttributes&&e.featureAttributeOrder&&o){s.featureAttributes={};for(const l of e.featureAttributeOrder){if(!e.featureAttributes[l])continue;const u=S(P({},e.featureAttributes[l]),{byteOffset:i,count:o});s.featureAttributes[l]=u,i+=(u.valueType==="UInt64"?8:z(u.valueType))*u.valuesPerElement*o}}return j(i,t.byteLength,"geometry"),s.byteCount=i-s.byteOffset,s}const R={position:O.POSITION,normal:O.NORMAL,color:O.COLOR,uv0:O.UV0,region:O.UVREGION};function Ue(t,e,n){if(t.encoding==="lepcc-rgb")return pe(e);if(t.encoding==="lepcc-intensity")return ge(e);if(t.encoding!=null&&t.encoding!=="")throw new p("unknown-attribute-storage-info-encoding","Unknown Attribute Storage Info Encoding");t["attributeByteCounts "]&&!t.attributeByteCounts&&(x.warn("Warning: Trailing space in 'attributeByteCounts '."),t.attributeByteCounts=t["attributeByteCounts "]),t.ordering[0]==="ObjectIds"&&t.hasOwnProperty("objectIds")&&(x.warn("Warning: Case error in objectIds"),t.ordering[0]="objectIds");const i=ve(e,t,n);j(i.byteOffset+i.byteCount,e.byteLength,"attribute");const s=i.entries.attributeValues||i.entries.objectIds;if(s){if(s.valueType==="String"){const r=i.entries.attributeByteCounts,a=T(e,r),c=me(e,s);return we(r.count,a,c)}return T(e,s)}throw new p("bad-attribute-storage-info","Bad attributeStorageInfo specification.")}const $={Float32:Float32Array,Float64:Float64Array,UInt8:Uint8Array,Int8:Int8Array,UInt16:Uint16Array,Int16:Int16Array,UInt32:Uint32Array,Int32:Int32Array},Oe={Float32:(t,e)=>new DataView(t,0).getFloat32(e,!0),Float64:(t,e)=>new DataView(t,0).getFloat64(e,!0),UInt8:(t,e)=>new DataView(t,0).getUint8(e),Int8:(t,e)=>new DataView(t,0).getInt8(e),UInt16:(t,e)=>new DataView(t,0).getUint16(e,!0),Int16:(t,e)=>new DataView(t,0).getInt16(e,!0),UInt32:(t,e)=>new DataView(t,0).getUint32(e,!0),Int32:(t,e)=>new DataView(t,0).getInt32(e,!0)};function H(t){return $.hasOwnProperty(t)}function z(t){return H(t)?$[t].BYTES_PER_ELEMENT:0}function Ie(t,e,n,i){const{rendererJSON:s,isRGBRenderer:r}=t;let a=null,c=null;if(e&&r)a=e;else if(e&&s.type==="pointCloudUniqueValueRenderer"){c=re.fromJSON(s);const o=c.colorUniqueValueInfos;a=new Uint8Array(3*i);const l=B(c.fieldTransformType);for(let u=0;u<i;u++){const f=(l?l(e[u]):e[u])+"";for(let d=0;d<o.length;d++)if(o[d].values.indexOf(f)>=0){a[3*u]=o[d].color.r,a[3*u+1]=o[d].color.g,a[3*u+2]=o[d].color.b;break}}}else if(e&&s.type==="pointCloudStretchRenderer"){c=ne.fromJSON(s);const o=c.stops;a=new Uint8Array(3*i);const l=B(c.fieldTransformType);for(let u=0;u<i;u++){const f=l?l(e[u]):e[u],d=o.length-1;if(f<o[0].value)a[3*u]=o[0].color.r,a[3*u+1]=o[0].color.g,a[3*u+2]=o[0].color.b;else if(f>=o[d].value)a[3*u]=o[d].color.r,a[3*u+1]=o[d].color.g,a[3*u+2]=o[d].color.b;else for(let b=1;b<o.length;b++)if(f<o[b].value){const g=(f-o[b-1].value)/(o[b].value-o[b-1].value);a[3*u]=o[b].color.r*g+o[b-1].color.r*(1-g),a[3*u+1]=o[b].color.g*g+o[b-1].color.g*(1-g),a[3*u+2]=o[b].color.b*g+o[b-1].color.b*(1-g);break}}}else if(e&&s.type==="pointCloudClassBreaksRenderer"){c=oe.fromJSON(s);const o=c.colorClassBreakInfos;a=new Uint8Array(3*i);const l=B(c.fieldTransformType);for(let u=0;u<i;u++){const f=l?l(e[u]):e[u];for(let d=0;d<o.length;d++)if(f>=o[d].minValue&&f<=o[d].maxValue){a[3*u]=o[d].color.r,a[3*u+1]=o[d].color.g,a[3*u+2]=o[d].color.b;break}}}else{a=new Uint8Array(3*i);for(let o=0;o<a.length;o++)a[o]=255}if(n&&c&&c.colorModulation){const o=c.colorModulation.minValue,l=c.colorModulation.maxValue,u=.3;for(let f=0;f<i;f++){const d=n[f],b=d>=l?1:d<=o?u:u+(1-u)*(d-o)/(l-o);a[3*f]=b*a[3*f],a[3*f+1]=b*a[3*f+1],a[3*f+2]=b*a[3*f+2]}}return a}function Ae(t,e){if(t.encoding==null||t.encoding===""){const n=Ce(e,t);if(W(n.vertexAttributes.position))return;const i=T(e,n.vertexAttributes.position),s=n.header.fields,r=[s.offsetX,s.offsetY,s.offsetZ],a=[s.scaleX,s.scaleY,s.scaleZ],c=i.length/3,o=new Float64Array(3*c);for(let l=0;l<c;l++)o[3*l]=i[3*l]*a[0]+r[0],o[3*l+1]=i[3*l+1]*a[1]+r[1],o[3*l+2]=i[3*l+2]*a[2]+r[2];return o}if(t.encoding==="lepcc-xyz")return de(e).result}function F(t,e,n){return U(t)&&t.attributeInfo.useElevation?Me(e,n):U(t)?Ue(t.attributeInfo.storageInfo,t.buffer,n):null}function Me(t,e){const n=new Float64Array(e);for(let i=0;i<e;i++)n[i]=t[3*i+2];return n}function Fe(t,e,n,i,s){const r=t.length/3;let a=0;for(let c=0;c<r;c++){let o=!0;for(let l=0;l<i.length&&o;l++){const{filterJSON:u}=i[l],f=s[l].values[c];switch(u.type){case"pointCloudValueFilter":{const d=u.mode==="exclude";u.values.indexOf(f)!==-1===d&&(o=!1);break}case"pointCloudBitfieldFilter":{const d=X(u.requiredSetBits),b=X(u.requiredClearBits);(f&d)===d&&!(f&b)||(o=!1);break}case"pointCloudReturnFilter":{const d=15&f,b=f>>>4&15,g=b>1,w=d===1,I=d===b;let D=!1;for(const A of u.includedReturns)if(A==="last"&&I||A==="firstOfMany"&&w&&g||A==="lastOfMany"&&I&&g||A==="single"&&!g){D=!0;break}D||(o=!1);break}}}o&&(n[a]=c,t[3*a]=t[3*c],t[3*a+1]=t[3*c+1],t[3*a+2]=t[3*c+2],e[3*a]=e[3*c],e[3*a+1]=e[3*c+1],e[3*a+2]=e[3*c+2],a++)}return a}function B(t){return t==null||t==="none"?null:t==="low-four-bit"?e=>15&e:t==="high-four-bit"?e=>(240&e)>>4:t==="absolute-value"?e=>Math.abs(e):t==="modulo-ten"?e=>e%10:null}function X(t){let e=0;for(const n of t||[])e|=1<<n;return e}class ze{transform(e){const n=this._transform(e),i=[n.points.buffer,n.rgb.buffer];U(n.pointIdFilterMap)&&i.push(n.pointIdFilterMap.buffer);for(const s of n.attributes)"buffer"in s.values&&J(s.values.buffer)&&s.values.buffer!==n.rgb.buffer&&i.push(s.values.buffer);return Promise.resolve({result:n,transferList:i})}_transform(e){const n=Ae(e.schema,e.geometryBuffer);let i=n.length/3,s=null;const r=[],a=F(e.primaryAttributeData,n,i);U(e.primaryAttributeData)&&a&&r.push({attributeInfo:e.primaryAttributeData.attributeInfo,values:a});const c=F(e.modulationAttributeData,n,i);U(e.modulationAttributeData)&&c&&r.push({attributeInfo:e.modulationAttributeData.attributeInfo,values:c});let o=Ie(e.rendererInfo,a,c,i);if(e.filterInfo&&e.filterInfo.length>0&&U(e.filterAttributesData)){const u=e.filterAttributesData.map(f=>{const d=F(f,n,i),b={attributeInfo:f.attributeInfo,values:d};return r.push(b),b});s=new Uint32Array(i),i=Fe(n,o,s,e.filterInfo,u)}for(const u of e.userAttributesData){const f=F(u,n,i);r.push({attributeInfo:u.attributeInfo,values:f})}3*i<o.length&&(o=new Uint8Array(o.buffer.slice(0,3*i))),this._applyElevationOffsetInPlace(n,i,e.elevationOffset);const l=this._transformCoordinates(n,i,e.obb,k.fromJSON(e.inSR),k.fromJSON(e.outSR));return{obb:e.obb,points:l,rgb:o,attributes:r,pointIdFilterMap:s}}_transformCoordinates(e,n,i,s,r){if(!te(e,s,0,e,r,0,n))throw Error("Can't reproject");const a=ee(i.center[0],i.center[1],i.center[2]),c=E(),o=E();Q(Z,i.quaternion);const l=new Float32Array(3*n);for(let u=0;u<n;u++)c[0]=e[3*u]-a[0],c[1]=e[3*u+1]-a[1],c[2]=e[3*u+2]-a[2],G(o,c,Z),i.halfSize[0]=Math.max(i.halfSize[0],Math.abs(o[0])),i.halfSize[1]=Math.max(i.halfSize[1],Math.abs(o[1])),i.halfSize[2]=Math.max(i.halfSize[2],Math.abs(o[2])),l[3*u]=c[0],l[3*u+1]=c[1],l[3*u+2]=c[2];return l}_applyElevationOffsetInPlace(e,n,i){if(i!==0)for(let s=0;s<n;s++)e[3*s+2]+=i}}const Z=le();function Te(){return new ze}export{Te as default};
